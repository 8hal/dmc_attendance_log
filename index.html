<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>마라톤 클럽 출석</title>
  <link rel="icon" href="assets/dmc_logo.png" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; margin:0; background:#f6f7f9; }
    .wrap { max-width:520px; margin:0 auto; padding:16px; }
    .card { background:#fff; border-radius:14px; padding:14px; box-shadow:0 1px 10px rgba(0,0,0,0.06); margin-bottom:12px; }
    h1 { font-size:18px; margin:0 0 10px 0; }
    .brand { display:flex; align-items:center; gap:10px; margin-bottom:10px; }
    .brand img { width:32px; height:32px; border-radius:8px; }
    .brand h1 { margin:0; }
    .row { margin:10px 0; }
    label { display:block; font-size:12px; color:#444; margin-bottom:6px; }
    input, select { width:100%; padding:12px; border-radius:10px; border:1px solid #d7dbe0; font-size:14px; background:#fff; box-sizing:border-box; }
    input[readonly] { background:#f1f3f5; }
    button { width:100%; padding:12px; border:0; border-radius:10px; font-size:15px; cursor:pointer; }
    button.primary { background:#111; color:#fff; }
    button.primary:disabled { background:#888; cursor:not-allowed; }
    .msg { font-size:13px; margin-top:10px; color:#111; }
    .msg.success { color:#1f6b3a; }
    .msg.error { color:#8a2353; }
    .meta { font-size:12px; color:#666; }
    .list { margin-top:10px; }
    .item { padding:10px 0; border-top:1px solid #eee; }
    .item:first-child { border-top:0; }
    .more { margin-top:10px; }
    .more button { width:100%; padding:10px; border-radius:10px; border:1px solid #d7dbe0; background:#fff; cursor:pointer; font-size:14px; }
    .nick { font-size:14px; }
    .sub { font-size:12px; color:#666; margin-top:4px; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; margin-left:6px; border:1px solid transparent; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="brand">
        <img alt="동탄마라톤클럽 로고" src="assets/dmc_logo.png" />
        <h1>출석 체크</h1>
      </div>

      <div class="row">
        <label>닉네임</label>
        <input id="nickname" type="text" placeholder="예: 게살볶음밥" />
      </div>

      <div class="row">
        <label>소속팀</label>
        <select id="team"></select>
      </div>

      <div class="row">
        <label>오늘 날짜(KST)</label>
        <input id="today" type="text" readonly />
      </div>

      <div class="row">
        <label>정모 유형</label>
        <select id="meetingType"></select>
      </div>

      <button id="submitBtn" class="primary">출석 체크</button>
      <div id="msg" class="msg" aria-live="polite"></div>
      <div class="meta" id="meta"></div>
    </div>

    <div class="card">
      <h1>오늘 출석 현황</h1>
      <div class="meta" id="todayCount"></div>
      <div class="list" id="list"></div>
      <div class="more" id="moreWrap" style="display:none;">
        <button id="moreBtn">더보기</button>
      </div>
    </div>
  </div>

<script>
  // Google Sheet
  const SHEET_ID = "13S3zHl2rHzJYdWEUvx1ID8iJAiHJuipw_6qDy1w0XP0";
  const SHEET_GID = "2002029408";

  // Google Form
  const FORM_ACTION_URL = "https://docs.google.com/forms/d/e/1FAIpQLSdWUfL9GeZFt3RobjLYwuJ3Wk3n0TBJaM4BD-OO5UcZ1DrtDA/formResponse";
  const ENTRY_NICK = "2688445";
  const ENTRY_TEAM = "1952386524";
  const ENTRY_DATE = "787715400";
  const ENTRY_MEETING = "1376201711";

  const TEAM_OPTIONS = ["S팀", "1팀", "2팀", "3팀", "4팀", "5팀"];
  const TEAM_COLORS = {
    "S팀": { bg: "#ffe8d9", text: "#8a3d00", border: "#ffd0b3" },
    "1팀": { bg: "#e6f1ff", text: "#124e8a", border: "#c7ddff" },
    "2팀": { bg: "#e9f7ee", text: "#1f6b3a", border: "#cfeedd" },
    "3팀": { bg: "#f3e8ff", text: "#5a2b8a", border: "#e2d1ff" },
    "4팀": { bg: "#fff5cc", text: "#7a5b00", border: "#ffe8a3" },
    "5팀": { bg: "#ffe7f1", text: "#8a2353", border: "#ffd0e2" }
  };

  const MEETING_TYPES = [
    { value: "화요일 정모", label: "화요일 정모" },
    { value: "목요일 정모", label: "목요일 정모" },
    { value: "토요일 정모", label: "토요일 정모" },
    { value: "번개", label: "번개" }
  ];
  const MEETING_LABEL_BY_VALUE = Object.fromEntries(
    MEETING_TYPES.map(item => [item.value, item.label])
  );

  const LS_NICK = "marathon_att_nickname";
  const LS_TEAM = "marathon_att_team";

  const elNick = document.getElementById("nickname");
  const elTeam = document.getElementById("team");
  const elToday = document.getElementById("today");
  const elMeeting = document.getElementById("meetingType");
  const elBtn = document.getElementById("submitBtn");
  const elMsg = document.getElementById("msg");
  const elMeta = document.getElementById("meta");
  const elCount = document.getElementById("todayCount");
  const elList = document.getElementById("list");
  const elMoreWrap = document.getElementById("moreWrap");
  let todayNickSet = new Set();
  let todayItems = [];
  let listShownCount = 0;

  function getListPageSize() {
    return window.matchMedia("(max-width: 480px)").matches ? 6 : 20;
  }

  function setMsg(t, type) {
    elMsg.textContent = t || "";
    elMsg.classList.remove("success", "error");
    if (type) elMsg.classList.add(type);
  }

  function kstTodayYYYYMMDD() {
    const fmt = new Intl.DateTimeFormat("en-CA", {
      timeZone: "Asia/Seoul",
      year: "numeric", month: "2-digit", day: "2-digit"
    });
    return fmt.format(new Date()).replace(/-/g, "/"); // yyyy/mm/dd (form expects slashes)
  }

  function kstDow() {
    const fmt = new Intl.DateTimeFormat("en-US", { timeZone: "Asia/Seoul", weekday: "short" });
    return fmt.format(new Date()); // Sun, Mon, Tue, Wed, Thu, Fri, Sat
  }

  function inferMeetingType() {
    const w = kstDow();
    if (w === "Tue") return "화요일 정모";
    if (w === "Thu") return "목요일 정모";
    if (w === "Sat") return "토요일 정모";
    return "번개";
  }

  function loadProfile() {
    const n = localStorage.getItem(LS_NICK) || "";
    const t = localStorage.getItem(LS_TEAM) || "";
    if (n) elNick.value = n;
    if (t) elTeam.value = t;
  }

  function saveProfile() {
    localStorage.setItem(LS_NICK, (elNick.value || "").trim());
    localStorage.setItem(LS_TEAM, (elTeam.value || "").trim());
  }

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, (m) => ({
      "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
    }[m]));
  }

  function renderList(items) {
    if (!items.length) {
      elList.innerHTML = `<div class="meta">아직 출석자가 없습니다.</div>`;
      elMoreWrap.style.display = "none";
      return;
    }
    elList.innerHTML = items.map(it => {
      const nick = escapeHtml(it.nickname);
      const team = escapeHtml(it.team || "");
      const teamStyle = TEAM_COLORS[it.team] || { bg: "#f1f3f5", text: "#444", border: "#e3e6ea" };
      const mtValue = it.meetingType || "";
      const mt = escapeHtml(MEETING_LABEL_BY_VALUE[mtValue] || mtValue);
      const ts = escapeHtml(it.timestamp || "");
      return `
        <div class="item">
          <div class="nick">${nick}${team ? `<span class="pill" style="background:${teamStyle.bg};color:${teamStyle.text};border-color:${teamStyle.border};">${team}</span>` : ""}</div>
          <div class="sub">${mt} · ${ts}</div>
        </div>
      `;
    }).join("");
  }

  function renderPagedList() {
    if (!todayItems.length) {
      renderList([]);
      return;
    }
    const slice = todayItems.slice(0, listShownCount);
    renderList(slice);
    elMoreWrap.style.display = listShownCount < todayItems.length ? "block" : "none";
  }

  function parseGviz(text) {
    const m = text.match(/setResponse\((.*)\);?\s*$/s);
    if (!m) throw new Error("gviz parse failed");
    return JSON.parse(m[1]);
  }

  // 시트 컬럼 가정:
  // A Timestamp, B 닉네임, C 소속팀, D 날짜, E 정모유형
  async function refreshTodayList() {
    const today = elToday.value;
    const q = `select A,B,C,D,E where D = '${today}' order by A desc`;
    const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${SHEET_GID}&tqx=out:json&tq=${encodeURIComponent(q)}`;

    try {
      const res = await fetch(url);
      const text = await res.text();
      const json = parseGviz(text);
      const rows = json.table.rows || [];

      const items = rows.map(r => {
        const c = r.c || [];
        return {
          timestamp: c[0]?.f || (c[0]?.v ? String(c[0].v) : ""),
          nickname: c[1]?.v || "",
          team: c[2]?.v || "",
          meetingType: c[4]?.v || ""
        };
      });

      todayItems = items;
      listShownCount = Math.min(getListPageSize(), todayItems.length);
      todayNickSet = new Set(items.map(it => String(it.nickname || "").trim().toLowerCase()));
      elCount.textContent = `${today} 출석 인원: ${items.length}명`;
      renderPagedList();
    } catch (e) {
      elCount.textContent = "목록을 불러오지 못했습니다. (시트를 웹에 게시했는지 확인해 주세요)";
      elList.innerHTML = "";
      elMoreWrap.style.display = "none";
    }
  }

  async function submitAttendance() {
    const nickname = (elNick.value || "").trim();
    const team = (elTeam.value || "").trim();
    const date = (elToday.value || "").trim();
    const meetingType = (elMeeting.value || "").trim();

    if (!nickname) {
      setMsg("닉네임을 입력해 주세요.", "error");
      return;
    }

    const nickKey = nickname.toLowerCase();
    if (todayNickSet.has(nickKey)) {
      setMsg("이미 오늘 출석이 등록되어 있습니다.", "error");
      return;
    }

    saveProfile();
    elBtn.disabled = true;
    setMsg("처리 중...");

    const formData = new FormData();
    formData.append(`entry.${ENTRY_NICK}`, nickname);
    formData.append(`entry.${ENTRY_TEAM}`, team);
    formData.append(`entry.${ENTRY_DATE}`, date);
    formData.append(`entry.${ENTRY_MEETING}`, meetingType);

    try {
      // Google Form은 CORS 응답을 안 주기 때문에 no-cors 사용
      await fetch(FORM_ACTION_URL, { method: "POST", mode: "no-cors", body: formData });
      setMsg("출석 완료", "success");
      elBtn.disabled = false;

      // 시트 반영 지연 고려
      setTimeout(refreshTodayList, 900);
    } catch (e) {
      setMsg("출석 처리에 실패했습니다. 네트워크 상태를 확인해 주세요.", "error");
      elBtn.disabled = false;
    }
  }

  function populateTeamOptions() {
    elTeam.innerHTML = TEAM_OPTIONS.map(team => (
      `<option value="${escapeHtml(team)}">${escapeHtml(team)}</option>`
    )).join("");
  }

  function populateMeetingOptions() {
    elMeeting.innerHTML = MEETING_TYPES.map(item => (
      `<option value="${escapeHtml(item.value)}">${escapeHtml(item.label)}</option>`
    )).join("");
  }

  function bootstrap() {
    populateTeamOptions();
    loadProfile();
    const today = kstTodayYYYYMMDD();
    elToday.value = today;
    populateMeetingOptions();
    elMeeting.value = inferMeetingType();
    elMeta.textContent = `자동 선택: ${MEETING_LABEL_BY_VALUE[elMeeting.value] || elMeeting.value}`;
    refreshTodayList();
  }

  document.getElementById("moreBtn").addEventListener("click", () => {
    listShownCount = Math.min(listShownCount + 20, todayItems.length);
    renderPagedList();
  });

  elBtn.addEventListener("click", submitAttendance);
  bootstrap();
</script>
</body>
</html>
