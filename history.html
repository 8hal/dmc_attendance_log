<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì›”ê°„ ê¸°ë¡ - ë™íƒ„ ë§ˆë¼í†¤ í´ëŸ½</title>
  <link rel="icon" href="assets/dmc_logo.png" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; margin:0; background:#f6f7f9; }
    /* ìŠ¤í…Œì´ì§• ì›Œí„°ë§ˆí¬ */
    body.staging-env::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 9999;
      background-image: repeating-linear-gradient(
        -45deg,
        transparent,
        transparent 80px,
        rgba(255, 100, 100, 0.03) 80px,
        rgba(255, 100, 100, 0.03) 160px
      );
      background-size: 200% 200%;
    }
    body.staging-env::after {
      content: "STAGING";
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-30deg);
      font-size: 120px;
      font-weight: 900;
      color: rgba(255, 50, 50, 0.06);
      pointer-events: none;
      z-index: 9998;
      white-space: nowrap;
      letter-spacing: 20px;
    }
    .wrap { max-width:520px; margin:0 auto; padding:16px; }
    .card { background:#fff; border-radius:14px; padding:14px; box-shadow:0 1px 10px rgba(0,0,0,0.06); margin-bottom:12px; }
    h1 { font-size:18px; margin:0 0 10px 0; }
    .meta { font-size:12px; color:#666; }
    .top-nav {
      position: sticky;
      top: 0;
      background: rgba(246,247,249,0.95);
      border-bottom: 1px solid #e3e6ea;
      padding: 10px 16px;
      backdrop-filter: blur(6px);
      z-index: 10;
    }
    .top-nav-inner { max-width:520px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; }
    .back-btn { display:inline-flex; align-items:center; gap:6px; padding:8px 12px; border-radius:10px; border:1px solid #d7dbe0; background:#fff; font-size:13px; cursor:pointer; }
    .nav-share-btn { display:none; align-items:center; gap:5px; padding:8px 14px; border-radius:10px; border:1px solid #1f7ae0; background:#fff; font-size:13px; font-weight:500; color:#1f7ae0; cursor:pointer; transition: all 0.15s; }
    .nav-share-btn:hover { background:#1f7ae0; color:#fff; }
    .nav-share-btn:active { transform:scale(0.97); }
    .nav-share-btn .icon { font-size:14px; }
    .hero { display:flex; align-items:center; gap:12px; margin:12px 0; }
    .hero-count { background:#111; color:#fff; padding:12px 16px; border-radius:12px; font-size:18px; font-weight:700; }
    .hero-text { font-size:12px; color:#555; }
    .rate-wrap { margin-top:8px; }
    .rate-label { font-size:12px; color:#555; margin-bottom:6px; }
    .rate-bar { height:10px; background:#e9edf3; border-radius:999px; overflow:hidden; border:1px solid #e1e6ed; }
    .rate-fill { height:100%; background:linear-gradient(90deg, #1f7ae0, #3aa0ff); width:0%; transition:width 0.4s ease; }
    .skeleton { position:relative; overflow:hidden; background:#e9edf3; border-radius:8px; }
    .skeleton::after {
      content:"";
      position:absolute;
      top:0;
      left:-60%;
      width:60%;
      height:100%;
      background:linear-gradient(90deg, rgba(233,237,243,0), rgba(255,255,255,0.7), rgba(233,237,243,0));
      animation:shimmer 1.2s infinite;
    }
    .skeleton-line { height:12px; margin:6px 0; }
    .skeleton-line.sm { height:10px; width:60%; }
    .skeleton-line.md { height:12px; width:80%; }
    .skeleton-line.lg { height:14px; width:90%; }
    .hero-count.loading { background:#e9edf3; color:transparent; position:relative; overflow:hidden; }
    .hero-count.loading::after {
      content:"";
      position:absolute;
      top:0;
      left:-60%;
      width:60%;
      height:100%;
      background:linear-gradient(90deg, rgba(233,237,243,0), rgba(255,255,255,0.7), rgba(233,237,243,0));
      animation:shimmer 1.2s infinite;
    }
    .rate-bar.loading { position:relative; overflow:hidden; }
    .rate-bar.loading::after {
      content:"";
      position:absolute;
      top:0;
      left:-60%;
      width:60%;
      height:100%;
      background:linear-gradient(90deg, rgba(233,237,243,0), rgba(255,255,255,0.6), rgba(233,237,243,0));
      animation:shimmer 1.2s infinite;
    }
    .cal-day.skeleton { background:#e9edf3; border-color:#e1e6ed; color:transparent; position:relative; overflow:hidden; }
    .cal-day.skeleton::after {
      content:"";
      position:absolute;
      top:0;
      left:-60%;
      width:60%;
      height:100%;
      background:linear-gradient(90deg, rgba(233,237,243,0), rgba(255,255,255,0.7), rgba(233,237,243,0));
      animation:shimmer 1.2s infinite;
    }
    @keyframes shimmer { to { transform: translateX(160%); } }
    .list { margin-top:10px; }
    .item { padding:10px 0; border-top:1px solid #eee; }
    .item:first-child { border-top:0; }
    .nick { font-size:14px; }
    .sub { font-size:12px; color:#666; margin-top:4px; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; margin-left:6px; border:1px solid transparent; }
    .pill.default { background:#f1f3f5; color:#444; border-color:#e3e6ea; }
    .calendar { margin-top:8px; }
    .cal-head-row { display:grid; grid-template-columns:repeat(7,1fr); gap:4px; margin-bottom:4px; }
    .cal-head-cell { font-size:11px; color:#777; text-align:center; }
    .cal-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:4px; }
    .cal-day { background:#f4f6f9; border:1px solid #e5e8ed; border-radius:10px; min-height:42px; display:flex; flex-direction:column; align-items:center; justify-content:center; font-size:12px; color:#444; transition:background 0.15s ease, color 0.15s ease, border-color 0.15s ease; }
    .cal-day.muted { background:#f9fafb; color:#b0b5bc; border-style:dashed; }
    .cal-day.dim { background:#fbfcfd; color:#c1c5cc; border-color:#eff1f5; }
    .cal-day.hit { background:#1f7ae0; color:#fff; border-color:#1f7ae0; box-shadow:0 6px 12px rgba(31,122,224,0.25); }
    
    /* ê³µìœ  ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .share-btn-wrap { margin-top:12px; display:flex; gap:8px; }
    .share-btn {
      flex:1;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      padding:12px 16px;
      border-radius:12px;
      border:1px solid #d7dbe0;
      background:#fff;
      font-size:14px;
      font-weight:500;
      cursor:pointer;
      transition:all 0.15s ease;
    }
    .share-btn:hover { background:#f6f7f9; }
    .share-btn:active { transform:scale(0.98); }
    .share-btn.primary { background:#111; color:#fff; border-color:#111; }
    .share-btn.primary:hover { background:#333; }
    .share-btn:disabled { opacity:0.5; cursor:not-allowed; }
    .share-btn .icon { font-size:16px; }
    
    /* ê³µìœ ìš© ìº¡ì²˜ ì¹´ë“œ (ìˆ¨ê¹€) - ìƒˆ ë””ìì¸ */
    .share-capture {
      position:absolute;
      left:-9999px;
      top:-9999px;
      width:360px;
      padding:32px 24px;
      background: linear-gradient(180deg, #f8fbff 0%, #ffffff 100%);
      border-radius:24px;
      text-align:center;
      font-family: system-ui, -apple-system, sans-serif;
    }
    /* ì›í˜• í”„ë¡œê·¸ë ˆìŠ¤ (ì´ë¯¸ì§€ ê¸°ë°˜) */
    .share-capture .progress-ring-wrap {
      position:relative;
      width:180px;
      height:180px;
      margin:0 auto 16px;
    }
    .share-capture .progress-ring-img {
      width:100%;
      height:100%;
    }
    .share-capture .progress-inner {
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%, -50%);
      text-align:center;
    }
    .share-capture .progress-percent {
      font-size:52px;
      font-weight:800;
      color:#1a5fb4;
      line-height:1;
    }
    .share-capture .progress-icon {
      font-size:32px;
      margin-top:8px;
    }
    /* íƒ€ì´í‹€ & ë‹‰ë„¤ì„ */
    .share-capture .share-title {
      font-size:12px;
      font-weight:600;
      color:#8a9ab0;
      letter-spacing:3px;
      text-transform:uppercase;
      margin-bottom:4px;
    }
    .share-capture .share-nickname {
      font-size:24px;
      font-weight:700;
      color:#1a3a5c;
      margin-bottom:4px;
    }
    .share-capture .share-month {
      font-size:16px;
      font-weight:500;
      color:#5a6a7a;
      margin-bottom:16px;
    }
    /* ìº˜ë¦°ë” ê·¸ë¦¬ë“œ (ì¶•ì†Œ) */
    .share-capture .share-cal-wrap {
      background:#fff;
      border-radius:12px;
      padding:12px;
      box-shadow:0 2px 12px rgba(26,95,180,0.08);
      max-width:280px;
      margin:0 auto;
    }
    .share-capture .share-cal-grid {
      display:grid;
      grid-template-columns:repeat(7,1fr);
      gap:4px;
    }
    .share-capture .share-cal-head {
      font-size:9px;
      font-weight:600;
      color:#8a9ab0;
      text-align:center;
      padding:2px 0;
    }
    .share-capture .share-cal-day {
      background:#f0f4f8;
      border:none;
      border-radius:4px;
      height:20px;
      width:20px;
      margin:1px auto;
    }
    .share-capture .share-cal-day.muted { 
      background:transparent; 
    }
    .share-capture .share-cal-day.dim { 
      background:#f5f7fa; 
    }
    .share-capture .share-cal-day.hit { 
      background:linear-gradient(135deg, #4a9eff 0%, #1a5fb4 100%);
      box-shadow:0 1px 4px rgba(26,95,180,0.35);
    }
    /* í†µê³„ */
    .share-capture .share-stats {
      display:flex;
      justify-content:center;
      gap:24px;
      margin-top:16px;
      padding-top:16px;
      border-top:1px solid #e8f0fa;
    }
    .share-capture .share-stat-item {
      text-align:center;
    }
    .share-capture .share-stat-value {
      font-size:24px;
      font-weight:800;
      color:#1a5fb4;
    }
    .share-capture .share-stat-label {
      font-size:11px;
      color:#8a9ab0;
      margin-top:2px;
    }
    .share-capture .share-footer {
      margin-top:16px;
      font-size:11px;
      color:#a0aab8;
    }
    
    /* í† ìŠ¤íŠ¸ ì•Œë¦¼ */
    .share-toast {
      position:fixed;
      bottom:24px;
      left:50%;
      transform:translateX(-50%) translateY(100px);
      background:#111;
      color:#fff;
      padding:12px 20px;
      border-radius:12px;
      font-size:13px;
      opacity:0;
      transition:all 0.3s ease;
      z-index:1000;
    }
    .share-toast.show {
      transform:translateX(-50%) translateY(0);
      opacity:1;
    }
  </style>
</head>
<body>
  <div class="top-nav" role="navigation" aria-label="ìƒë‹¨ ë‚´ë¹„ê²Œì´ì…˜">
    <div class="top-nav-inner">
      <button class="back-btn" type="button" onclick="goBackToIndex()">â† ë’¤ë¡œ ê°€ê¸°</button>
      <button class="nav-share-btn" id="navShareBtn" type="button" onclick="shareToSNS()">
        <span class="icon">ğŸ“¤</span> ê³µìœ í•˜ê¸°
      </button>
    </div>
  </div>
  <div class="wrap">
    <div class="card">
      <h1 id="title">ì›”ê°„ ì¶œì„ ê¸°ë¡</h1>
      <div class="meta" id="summary"></div>
      <div class="hero">
        <div class="hero-count" id="countBox">0íšŒ</div>
        <div class="hero-text" id="heroText"></div>
      </div>
      <div class="rate-wrap">
        <div class="rate-label" id="rateLabel">ì¶œì„ë¥  0%</div>
        <div class="rate-bar" aria-hidden="true">
          <div class="rate-fill" id="rateFill"></div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="calendar">
        <div class="cal-head-row">
          <div class="cal-head-cell">ì¼</div>
          <div class="cal-head-cell">ì›”</div>
          <div class="cal-head-cell">í™”</div>
          <div class="cal-head-cell">ìˆ˜</div>
          <div class="cal-head-cell">ëª©</div>
          <div class="cal-head-cell">ê¸ˆ</div>
          <div class="cal-head-cell">í† </div>
        </div>
        <div class="cal-grid" id="calendarGrid"></div>
      </div>
    </div>
    <div class="card">
      <h1>ì¶œì„ ë¦¬ìŠ¤íŠ¸</h1>
      <div class="list" id="list"></div>
    </div>
    
  </div>
  
  <!-- ê³µìœ ìš© ìº¡ì²˜ ì¹´ë“œ (í™”ë©´ ë°–ì— ìˆ¨ê¹€) -->
  <div class="share-capture" id="shareCapture">
    <!-- ì›í˜• í”„ë¡œê·¸ë ˆìŠ¤ -->
    <div class="progress-ring-wrap">
      <img src="assets/progress_0.svg" alt="" class="progress-ring-img" id="progressRingImg" />
      <div class="progress-inner">
        <div class="progress-percent" id="sharePercent">0%</div>
        <div class="progress-icon">ğŸƒ</div>
      </div>
    </div>
    
    <!-- íƒ€ì´í‹€ & ë‹‰ë„¤ì„ -->
    <div class="share-title">MONTHLY ATTENDANCE</div>
    <div class="share-nickname" id="shareNickname">ë‹‰ë„¤ì„</div>
    <div class="share-month" id="shareMonth">2026ë…„ 1ì›”</div>
    
    <!-- ìº˜ë¦°ë” -->
    <div class="share-cal-wrap">
      <div class="share-cal-grid" id="shareCalGrid">
        <!-- ìº˜ë¦°ë” ë™ì  ìƒì„± -->
      </div>
    </div>
    
    <!-- í†µê³„ -->
    <div class="share-stats">
      <div class="share-stat-item">
        <div class="share-stat-value" id="shareCount">0</div>
        <div class="share-stat-label">ì¶œì„ íšŸìˆ˜</div>
      </div>
      <div class="share-stat-item">
        <div class="share-stat-value" id="shareTotalDays">0</div>
        <div class="share-stat-label">ëª¨ì„ ì¼ìˆ˜</div>
      </div>
    </div>
    
    <div class="share-footer">ë™íƒ„ ë§ˆë¼í†¤ í´ëŸ½ ğŸƒ (v5)</div>
  </div>
  
  <!-- í† ìŠ¤íŠ¸ ì•Œë¦¼ -->
  <div class="share-toast" id="shareToast"></div>

<!-- html2canvas CDN -->
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<script>
  // Firebase Cloud Functions URL
  const IS_LOCAL = location.hostname === "localhost" || location.hostname === "127.0.0.1" || location.hostname.startsWith("192.168.") || location.hostname.startsWith("172.");
  const IS_STAGING = location.hostname.includes("dmc-attendance-staging");
  const PROD_URL = "https://asia-northeast3-dmc-attendance.cloudfunctions.net/attendance";
  const STAGING_URL = "https://asia-northeast3-dmc-attendance-staging.cloudfunctions.net/attendance";
  const LOCAL_URL = `http://${location.hostname}:5001/dmc-attendance/asia-northeast3/attendance`;
  const BASE_URL = IS_LOCAL ? LOCAL_URL : (IS_STAGING ? STAGING_URL : PROD_URL);
  
  // ìŠ¤í…Œì´ì§• í™˜ê²½ í‘œì‹œ
  if (IS_STAGING) {
    document.body.classList.add("staging-env");
  }
  const GA_MEASUREMENT_ID = "G-TN57D4SNM1";
  const LS_HISTORY_PREFIX = "marathon_att_history:";

  const TEAM_COLORS = {
    "SíŒ€": { bg: "#ffe8d9", text: "#8a3d00", border: "#ffd0b3" },
    "1íŒ€": { bg: "#e6f1ff", text: "#124e8a", border: "#c7ddff" },
    "2íŒ€": { bg: "#e9f7ee", text: "#1f6b3a", border: "#cfeedd" },
    "3íŒ€": { bg: "#f3e8ff", text: "#5a2b8a", border: "#e2d1ff" },
    "4íŒ€": { bg: "#fff5cc", text: "#7a5b00", border: "#ffe8a3" },
    "5íŒ€": { bg: "#ffe7f1", text: "#8a2353", border: "#ffd0e2" }
  };

  function initAnalytics() {
    if (!GA_MEASUREMENT_ID || typeof window.gtag === "function") return;
    window.dataLayer = window.dataLayer || [];
    function gtag() { window.dataLayer.push(arguments); }
    window.gtag = gtag;
    gtag("js", new Date());
    gtag("config", GA_MEASUREMENT_ID, { send_page_view: true });
    const script = document.createElement("script");
    script.async = true;
    script.src = `https://www.googletagmanager.com/gtag/js?id=${encodeURIComponent(GA_MEASUREMENT_ID)}`;
    document.head.appendChild(script);
  }

  function trackEvent(name, params) {
    if (!GA_MEASUREMENT_ID || typeof window.gtag !== "function") return;
    window.gtag("event", name, params || {});
  }

  function qs(name) {
    return new URL(location.href).searchParams.get(name) || "";
  }

  function escapeHtml(s) {
    return String(s || "").replace(/[&<>"']/g, (m) => ({
      "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
    }[m]));
  }

  function getHistoryCacheKey_(nickname, month) {
    return `${LS_HISTORY_PREFIX}${nickname}::${month}`;
  }

  function getCachedHistory_(nickname, month) {
    if (!nickname || !month) return null;
    try {
      const raw = localStorage.getItem(getHistoryCacheKey_(nickname, month));
      if (!raw) return null;
      const parsed = JSON.parse(raw);
      if (!parsed || !parsed.history) return null;
      return parsed.history;
    } catch (e) {
      return null;
    }
  }

  function setCachedHistory_(nickname, month, history) {
    if (!nickname || !month || !history) return;
    try {
      const payload = { savedAt: Date.now(), history };
      localStorage.setItem(getHistoryCacheKey_(nickname, month), JSON.stringify(payload));
    } catch (e) {
      // ignore storage errors
    }
  }

  function setHistoryLoading(isLoading) {
    const summary = document.getElementById("summary");
    const countBox = document.getElementById("countBox");
    const rateLabel = document.getElementById("rateLabel");
    const rateBar = document.querySelector(".rate-bar");
    const list = document.getElementById("list");
    const grid = document.getElementById("calendarGrid");
    if (!isLoading) {
      countBox.classList.remove("loading");
      rateBar.classList.remove("loading");
      return;
    }
    summary.innerHTML = `<span class="skeleton skeleton-line md"></span>`;
    countBox.textContent = "";
    countBox.classList.add("loading");
    rateLabel.innerHTML = `<span class="skeleton skeleton-line sm"></span>`;
    rateBar.classList.add("loading");
    list.innerHTML = Array.from({ length: 4 }, () => (
      `<div class="item">
        <div class="skeleton skeleton-line lg"></div>
        <div class="skeleton skeleton-line sm"></div>
      </div>`
    )).join("");
    grid.innerHTML = Array.from({ length: 35 }, () => `<div class="cal-day skeleton"></div>`).join("");
  }

  function renderSummary(nickname, month, count, summaryByType, attendanceRate) {
    const el = document.getElementById("summary");
    const parts = [];
    if (summaryByType) {
      const kv = Object.entries(summaryByType).map(([k, v]) => `${k}: ${v}íšŒ`);
      if (kv.length) parts.push(kv.join(" Â· "));
    }
    el.textContent = `${month} ì¶œì„ ìš”ì•½${parts.length ? " Â· " + parts.join(" | ") : ""}`;
    document.getElementById("countBox").textContent = `${count || 0}íšŒ`;
    document.getElementById("heroText").textContent = "";
    const rate = Number.isFinite(attendanceRate) ? Math.max(0, Math.min(100, attendanceRate)) : 0;
    document.getElementById("rateLabel").textContent = `ì¶œì„ë¥  ${rate}%`;
    document.getElementById("rateFill").style.width = `${rate}%`;
  }

  function renderList(items) {
    const el = document.getElementById("list");
    if (!items || !items.length) {
      el.innerHTML = `<div class="meta">ì¶œì„ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
      return;
    }
    el.innerHTML = items.map(it => {
      const teamLabel = escapeHtml(it.teamLabel || it.team || "");
      const teamStyle = TEAM_COLORS[it.teamLabel] || { bg: "#f1f3f5", text: "#444", border: "#e3e6ea" };
      const mtLabel = escapeHtml(it.meetingTypeLabel || it.meetingType || "");
      const ts = escapeHtml(it.timeText || "");
      return `
        <div class="item">
          <div class="nick">${teamLabel ? `<span class="pill" style="background:${teamStyle.bg};color:${teamStyle.text};border-color:${teamStyle.border};">${teamLabel}</span>` : mtLabel}</div>
          <div class="sub">${it.meetingDate || ""} Â· ${mtLabel}${ts ? ` Â· ${ts}` : ""}</div>
        </div>
      `;
    }).join("");
  }

  function renderCalendar(monthKey, items) {
    const grid = document.getElementById("calendarGrid");
    grid.innerHTML = "";
    if (!monthKey) return;
    const [y, m] = monthKey.split("-").map(Number);
    const first = new Date(y, m - 1, 1);
    const startOffset = first.getDay(); // 0=Sun
    const daysInMonth = new Date(y, m, 0).getDate();
    const attended = new Set(
      (items || [])
        .map(it => (it.meetingDate || "").split("/")[2])
        .map(d => Number(d))
        .filter(Boolean)
    );
    const cells = [];
    for (let i = 0; i < startOffset; i++) cells.push({ empty: true });
    for (let d = 1; d <= daysInMonth; d++) {
      const weekday = new Date(y, m - 1, d).getDay(); // 0=Sun ..6=Sat
      const isMeetDay = [2, 4, 6].includes(weekday); // í™”, ëª©, í† 
      const hit = attended.has(d);
      cells.push({ day: d, hit, dim: !isMeetDay && !hit });
    }
    // fill remaining to full weeks
    while (cells.length % 7 !== 0) cells.push({ empty: true });
    grid.innerHTML = cells.map(c => {
      if (c.empty) return `<div class="cal-day muted"></div>`;
      return `<div class="cal-day${c.hit ? " hit" : ""}${c.dim ? " dim" : ""}">${c.day}</div>`;
    }).join("");
  }

  async function loadHistory() {
    initAnalytics();
    const nickname = qs("nickname").trim();
    const month = qs("month").trim();
    trackEvent("history_view", {
      nickname_present: Boolean(nickname),
      month: month || null
    });
    if (!nickname || !month) {
      document.getElementById("summary").textContent = "ë‹‰ë„¤ì„/ì›” ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.";
      return;
    }
    document.getElementById("title").textContent = `${nickname} Â· ${month} ì¶œì„`;
    const url = `${BASE_URL}?action=history&nickname=${encodeURIComponent(nickname)}&month=${encodeURIComponent(month)}`;
    const fetchStart = performance.now();
    const cached = getCachedHistory_(nickname, month);
    if (cached) {
      setHistoryLoading(false);
      renderSummary(
        cached.nickname || nickname,
        cached.month || month,
        cached.count,
        cached.summaryByType,
        cached.attendanceRate
      );
      renderList(cached.items || []);
      renderCalendar(cached.month || month, cached.items || []);
      
      // ìºì‹œì—ì„œë„ ê³µìœ  ê¸°ëŠ¥ í™œì„±í™”
      const cachedRate = Number.isFinite(cached.attendanceRate) ? Math.max(0, Math.min(100, cached.attendanceRate)) : 0;
      renderShareCapture(nickname, cached.month || month, cached.count, cachedRate, cached.items || []);
      showShareButtons();
    } else {
      setHistoryLoading(true);
    }
    try {
      const res = await fetch(url);
      const json = await res.json();
      if (!json.ok) throw new Error(json.error || "history fetch failed");
      setHistoryLoading(false);
      setCachedHistory_(nickname, month, json);
      renderSummary(
        json.nickname || nickname,
        json.month || month,
        json.count,
        json.summaryByType,
        json.attendanceRate
      );
      renderList(json.items || []);
      renderCalendar(json.month || month, json.items || []);
      
      // ê³µìœ  ê¸°ëŠ¥ í™œì„±í™”
      const rate = Number.isFinite(json.attendanceRate) ? Math.max(0, Math.min(100, json.attendanceRate)) : 0;
      renderShareCapture(nickname, json.month || month, json.count, rate, json.items || []);
      showShareButtons();
      
      trackEvent("history_fetch_success", {
        month: json.month || month,
        latency_ms: Math.round(performance.now() - fetchStart),
        count: json.items?.length ?? 0
      });
    } catch (e) {
      setHistoryLoading(false);
      document.getElementById("summary").textContent = "ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
      document.getElementById("list").innerHTML = `<div class="meta">${escapeHtml(e && e.message ? e.message : e)}</div>`;
    }
  }

  function goBackToIndex() {
    const month = qs("month").trim();
    trackEvent("history_back_click", { month: month || null });
    window.location.href = "index.html";
  }

  // ========== SNS ê³µìœ  ê¸°ëŠ¥ ==========
  
  let shareData = null; // ê³µìœ ìš© ë°ì´í„° ì €ì¥
  
  function showShareButtons() {
    // ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ê³µìœ  ë²„íŠ¼ í‘œì‹œ
    document.getElementById("navShareBtn").style.display = "inline-flex";
  }
  
  function showToast(message) {
    const toast = document.getElementById("shareToast");
    toast.textContent = message;
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 2500);
  }
  
  function renderShareCapture(nickname, month, count, rate, items) {
    // ì¶œì„ë¥  ì›í˜• í”„ë¡œê·¸ë ˆìŠ¤ (10% ë‹¨ìœ„ ì´ë¯¸ì§€)
    const rateNum = Number(rate) || 0;
    document.getElementById("sharePercent").textContent = `${rateNum}%`;
    const roundedRate = Math.round(rateNum / 10) * 10; // 10% ë‹¨ìœ„ë¡œ ë°˜ì˜¬ë¦¼
    document.getElementById("progressRingImg").src = `assets/progress_${roundedRate}.svg`;
    
    // ë‹‰ë„¤ì„ í‘œì‹œ
    document.getElementById("shareNickname").textContent = nickname || "ë‹‰ë„¤ì„";
    
    // ì›” í‘œì‹œ
    if (month) {
      const [y, m] = month.split("-").map(Number);
      document.getElementById("shareMonth").textContent = `${y}ë…„ ${m}ì›”`;
    }
    
    // í†µê³„
    document.getElementById("shareCount").textContent = count || 0;
    
    // ìº˜ë¦°ë” ë Œë”ë§
    const grid = document.getElementById("shareCalGrid");
    grid.innerHTML = "";
    
    if (!month) return;
    const [y, m] = month.split("-").map(Number);
    const first = new Date(y, m - 1, 1);
    const startOffset = first.getDay();
    const daysInMonth = new Date(y, m, 0).getDate();
    const attended = new Set(
      (items || [])
        .map(it => (it.meetingDate || "").split("/")[2])
        .map(d => Number(d))
        .filter(Boolean)
    );
    
    // ëª¨ì„ ì¼ìˆ˜ ê³„ì‚° (í™”, ëª©, í† )
    let meetDaysCount = 0;
    for (let d = 1; d <= daysInMonth; d++) {
      const weekday = new Date(y, m - 1, d).getDay();
      if ([2, 4, 6].includes(weekday)) meetDaysCount++;
    }
    document.getElementById("shareTotalDays").textContent = meetDaysCount;
    
    // ìš”ì¼ í—¤ë”
    ["ì¼","ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† "].forEach(day => {
      const cell = document.createElement("div");
      cell.className = "share-cal-head";
      cell.textContent = day;
      grid.appendChild(cell);
    });
    
    // ë¹ˆ ì¹¸
    for (let i = 0; i < startOffset; i++) {
      const cell = document.createElement("div");
      cell.className = "share-cal-day muted";
      grid.appendChild(cell);
    }
    
    // ë‚ ì§œ (ìˆ«ì ì—†ì´ ìƒ‰ì¹ ë§Œ)
    for (let d = 1; d <= daysInMonth; d++) {
      const weekday = new Date(y, m - 1, d).getDay();
      const isMeetDay = [2, 4, 6].includes(weekday);
      const hit = attended.has(d);
      const cell = document.createElement("div");
      cell.className = `share-cal-day${hit ? " hit" : ""}${!isMeetDay && !hit ? " dim" : ""}`;
      // ìˆ«ì í‘œì‹œ ì•ˆ í•¨
      grid.appendChild(cell);
    }
    
    // ë‚¨ì€ ì¹¸ ì±„ìš°ê¸°
    const totalCells = startOffset + daysInMonth;
    const remaining = (7 - (totalCells % 7)) % 7;
    for (let i = 0; i < remaining; i++) {
      const cell = document.createElement("div");
      cell.className = "share-cal-day muted";
      grid.appendChild(cell);
    }
    
    // ê³µìœ  ë°ì´í„° ì €ì¥
    shareData = { nickname, month, count, rate };
  }
  
  async function generateShareImage() {
    const captureEl = document.getElementById("shareCapture");
    
    // ìº¡ì²˜ë¥¼ ìœ„í•´ ì ì‹œ í™”ë©´ì— í‘œì‹œ
    captureEl.style.position = "fixed";
    captureEl.style.left = "0";
    captureEl.style.top = "0";
    captureEl.style.zIndex = "-1";
    captureEl.style.opacity = "1";
    
    try {
      const canvas = await html2canvas(captureEl, {
        backgroundColor: "#ffffff",
        scale: 2, // ê³ í•´ìƒë„
        useCORS: true,
        allowTaint: true,
        logging: false
      });
      
      return canvas;
    } finally {
      // ë‹¤ì‹œ ìˆ¨ê¸°ê¸°
      captureEl.style.position = "absolute";
      captureEl.style.left = "-9999px";
      captureEl.style.top = "-9999px";
      captureEl.style.zIndex = "";
      captureEl.style.opacity = "";
    }
  }
  
  async function downloadShareImage() {
    trackEvent("share_download_click", { month: shareData?.month });
    
    try {
      const canvas = await generateShareImage();
      const link = document.createElement("a");
      link.download = `ì¶œì„_${shareData?.nickname || "ê¸°ë¡"}_${shareData?.month || "ì›”ê°„"}.png`;
      link.href = canvas.toDataURL("image/png");
      link.click();
      showToast("âœ… ì´ë¯¸ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤");
      trackEvent("share_download_success", { month: shareData?.month });
    } catch (e) {
      console.error("ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨:", e);
      showToast("âŒ ì´ë¯¸ì§€ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤");
      trackEvent("share_download_error", { error: String(e) });
    }
  }
  
  async function shareToSNS() {
    trackEvent("share_sns_click", { month: shareData?.month });
    
    try {
      const canvas = await generateShareImage();
      
      // Canvasë¥¼ Blobìœ¼ë¡œ ë³€í™˜
      const blob = await new Promise(resolve => canvas.toBlob(resolve, "image/png"));
      const file = new File([blob], `ì¶œì„_${shareData?.nickname || "ê¸°ë¡"}.png`, { type: "image/png" });
      
      // Web Share API ì§€ì› í™•ì¸
      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        await navigator.share({
          title: `ğŸƒ ${shareData?.nickname} ì¶œì„ ê¸°ë¡`,
          text: `${shareData?.month} ì¶œì„ ${shareData?.count}íšŒ (ì¶œì„ë¥  ${shareData?.rate}%)`,
          files: [file]
        });
        showToast("âœ… ê³µìœ ë˜ì—ˆìŠµë‹ˆë‹¤");
        trackEvent("share_sns_success", { month: shareData?.month });
      } else if (navigator.share) {
        // íŒŒì¼ ê³µìœ  ë¯¸ì§€ì› ì‹œ í…ìŠ¤íŠ¸ë§Œ ê³µìœ 
        await navigator.share({
          title: `ğŸƒ ${shareData?.nickname} ì¶œì„ ê¸°ë¡`,
          text: `${shareData?.month} ì¶œì„ ${shareData?.count}íšŒ (ì¶œì„ë¥  ${shareData?.rate}%)\n\n#ë™íƒ„ë§ˆë¼í†¤í´ëŸ½ #ì¶œì„ì¸ì¦`,
          url: window.location.href
        });
        showToast("âœ… ê³µìœ ë˜ì—ˆìŠµë‹ˆë‹¤");
        trackEvent("share_sns_text_only", { month: shareData?.month });
      } else {
        // Web Share API ë¯¸ì§€ì› ì‹œ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œë¡œ í´ë°±
        await downloadShareImage();
        showToast("ğŸ’¡ ì´ë¯¸ì§€ë¥¼ ì €ì¥í•œ í›„ SNSì—ì„œ ì§ì ‘ ê³µìœ í•´ì£¼ì„¸ìš”");
        trackEvent("share_sns_fallback_download", { month: shareData?.month });
      }
    } catch (e) {
      if (e.name === "AbortError") {
        // ì‚¬ìš©ìê°€ ê³µìœ  ì·¨ì†Œ
        trackEvent("share_sns_cancelled", { month: shareData?.month });
        return;
      }
      console.error("ê³µìœ  ì‹¤íŒ¨:", e);
      showToast("âŒ ê³µìœ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì´ë¯¸ì§€ë¥¼ ì €ì¥í•´ì£¼ì„¸ìš”.");
      trackEvent("share_sns_error", { error: String(e) });
    }
  }

  loadHistory();
</script>
</body>
</html>
